<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using the Fully Bayesian Model in rubias • rubias</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using the Fully Bayesian Model in rubias">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rubias</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/rubias-fully-bayesian.html">Using the Fully Bayesian Model in rubias</a></li>
    <li><a class="dropdown-item" href="../articles/rubias-overview.html">An Overview of rubias Usage</a></li>
    <li><a class="dropdown-item" href="../articles/rubias-underlying-data-structures.html">An Explanation of the Underlying Data Structures in rubias</a></li>
    <li><a class="dropdown-item" href="../articles/uncertainty-on-total-catch.html">Summarizing Uncertainty on Stock-Specific Total Catch</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/eriqande/rubias/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using the Fully Bayesian Model in rubias</h1>
                        <h4 data-toc-skip class="author">Ben Moran</h4>
            
            <h4 data-toc-skip class="date">6/3/2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/eriqande/rubias/blob/HEAD/vignettes/rubias-fully-bayesian.Rmd" class="external-link"><code>vignettes/rubias-fully-bayesian.Rmd</code></a></small>
      <div class="d-none name"><code>rubias-fully-bayesian.Rmd</code></div>
    </div>

    
    
<p>The default model in <code>rubias</code> is a conditional model in
which inference is done with the baseline (reference) allele counts
fixed. The package now also includes a fully Bayesian GSI model, as is
implemented in the software packages <code>BAYES</code> and
<code>cBayes</code>, among others. This model differs from the
conditional model in two main respects:</p>
<ul>
<li>Individuals within the mixture that are allocated (on any particular
step of the MCMC) to one of the reference samples have their genotypes
added to that reference sample’s allele counts.</li>
<li>These updated allele counts are used as Dirichlet parameters to
explicitly draw an estimate of baseline allele frequecies, from which
genotype likelihoods are calculated (in the conditional model, genotype
likelihoods are pulled straight from the Dirichlet parameters using a
Compound Dirichlet-Multinomial distribution).</li>
</ul>
<p>Ideally, updating the reference allele counts with mixture genotypes
will refine the estimate of allele frequencies in that sample. This is
especially useful in cases where the reference dataset is small relative
to the number of mixture individuals, as well as those in which the
mixture contains populations not present in the baseline. However, the
fully Bayesian model is much more computationally intensive, and can
exhibit pathological behavior when reference collections are not
well-differentiated.</p>
<div class="section level2">
<h2 id="running-the-model-with-baseline-resampling">Running the Model with Baseline Resampling<a class="anchor" aria-label="anchor" href="#running-the-model-with-baseline-resampling"></a>
</h2>
<p>Load the required packages first:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eriqande/rubias" class="external-link">rubias</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<p>The basic way to invoke the fully Bayesian model is to use the
<code>infer_mixture</code> function with the <code>method</code> option
set to “BR” (for “baseline resampling”). <strong>NOTE:</strong> We use
very few reps here to not take too much time when checking this package
for CRAN. You should use more…</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/infer_mixture.html">infer_mixture</a></span><span class="op">(</span></span>
<span>  reference <span class="op">=</span> <span class="va">small_chinook_ref</span>, </span>
<span>  mixture <span class="op">=</span> <span class="va">small_chinook_mix</span>, </span>
<span>  gen_start_col <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"BR"</span>,</span>
<span>  reps <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">35</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Collating data; compiling reference allele frequencies, etc.   time: 0.11 seconds</span></span>
<span><span class="co">## Computing reference locus specific means and variances for computing mixture z-scores   time: 0.01 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec3 with 29 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 100 sweeps of method "BR", 35 sweeps of which are burn-in.   time: 0.03 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if</span></span>
<span><span class="co">## `.name_repair` is omitted as of tibble 2.0.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Using compatibility `.name_repair`.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">rubias</span> package.</span></span>
<span><span class="co">##   Please report the issue at <span style="color: #0000BB; font-style: italic;">&lt;https://github.com/eriqande/rubias/issues&gt;</span>.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<pre><code><span><span class="co">##    time: 0.13 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec1 with 36 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 100 sweeps of method "BR", 35 sweeps of which are burn-in.   time: 0.03 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.10 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec2 with 35 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 100 sweeps of method "BR", 35 sweeps of which are burn-in.   time: 0.03 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.10 seconds</span></span></code></pre>
<p>Note that the output generated by “BR” is still a list of four tidy
data frames, but the <code>bootstrapped_proportions</code> data frame of
methods “MCMC” and “PB” is replaced with an
<code>allele_frequencies</code> data frame. This data frame contains the
posterior mean allele frequencies (theta) for each population, updated
based on the allocations of mixture individuals throughout MCMC. The
first three columns specify the mixture collection, locus and allele in
question, and all subsequent columns report the frequency for a
particular population.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_model</span><span class="op">$</span><span class="va">allele_frequencies</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 546 × 9</span></span></span>
<span><span class="co">##    mixture_collection locus   allele Deer_Cr_sp Feather_H_fa Sacramento_H  Eel_R</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> rec3               AldB1.… 2          0.836       0.916        0.900   0.937 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> rec3               AldB1.… 4          0.164       0.084<span style="text-decoration: underline;">0</span>       0.100   0.062<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> rec3               AldoB4… 1          0.030<span style="text-decoration: underline;">8</span>      0.001<span style="text-decoration: underline;">80</span>      0.001<span style="text-decoration: underline;">01</span> 0.047<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> rec3               AldoB4… 4          0.969       0.998        0.999   0.952 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> rec3               OTNAML… 1          0.225       0.209        0.455   0.247 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> rec3               OTNAML… 3          0.775       0.791        0.545   0.753 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> rec3               Ots_10… 2          0.105       0.101        0.127   0.650 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> rec3               Ots_10… 4          0.895       0.899        0.873   0.350 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> rec3               Ots_10… 2          0.542       0.545        0.425   0.901 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> rec3               Ots_10… 4          0.458       0.455        0.575   0.099<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 536 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 2 more variables: Klamath_IGH_fa &lt;dbl&gt;, Umpqua_sp &lt;dbl&gt;</span></span></span></code></pre>
<p>Also note that the log-likelihoods and Z-scores included in the
<code>indiv_posteriors</code> output data frame are calculated using
only the reference allele counts prior to MCMC, and so do
<strong>not</strong> utilize the full model results.</p>
<p>Let’s compare the results of this to those from the conditional
model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">cond_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/infer_mixture.html">infer_mixture</a></span><span class="op">(</span></span>
<span>  reference <span class="op">=</span> <span class="va">small_chinook_ref</span>, </span>
<span>  mixture <span class="op">=</span> <span class="va">small_chinook_mix</span>, </span>
<span>  gen_start_col <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"MCMC"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Collating data; compiling reference allele frequencies, etc.   time: 0.10 seconds</span></span>
<span><span class="co">## Computing reference locus specific means and variances for computing mixture z-scores   time: 0.01 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec3 with 29 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 2000 total sweeps, 100 of which are burn-in and will not be used in computing averages in method "MCMC"   time: 0.02 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.01 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec1 with 36 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 2000 total sweeps, 100 of which are burn-in and will not be used in computing averages in method "MCMC"   time: 0.02 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.01 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec2 with 35 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 2000 total sweeps, 100 of which are burn-in and will not be used in computing averages in method "MCMC"   time: 0.02 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.01 seconds</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comppi</span> <span class="op">&lt;-</span> <span class="va">cond_model</span><span class="op">$</span><span class="va">mixing_proportions</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cond_pi <span class="op">=</span> <span class="va">pi</span>, full_pi <span class="op">=</span> <span class="va">full_model</span><span class="op">$</span><span class="va">mixing_proportions</span><span class="op">$</span><span class="va">pi</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">comppi</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cond_pi</span>, y <span class="op">=</span> <span class="va">full_pi</span>, colour <span class="op">=</span> <span class="va">collection</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">mixture_collection</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rubias-fully-bayesian_files/figure-html/compare-1.png" width="672"></p>
<p>The two methods are largely in agreement for this small test set.</p>
<div class="section level3">
<h3 id="initializing-mixture-proportions-with-the-conditional-model">Initializing Mixture Proportions with the Conditional Model<a class="anchor" aria-label="anchor" href="#initializing-mixture-proportions-with-the-conditional-model"></a>
</h3>
<p>When collections are poorly resolved, the fully Bayesian model may
show pathological behaviors such as allocating all individuals to only
one of the closely related populations. One way to reduce this behavior
is to initialize the fully Bayesian model with the output from the
conditional model. <code>rubias</code> explicitly supports this through
the options <code>prelim_reps</code> and <code>prelim_burn_in</code>: if
changed from the <code>NULL</code> default, these parameters specify
conditional MCMC cycles to perform, the posterior mean mixing
proportions of which are used as the initial mixing proportion estimates
in the fully Bayesian model. For example:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">prelim_full_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/infer_mixture.html">infer_mixture</a></span><span class="op">(</span></span>
<span>  reference <span class="op">=</span> <span class="va">small_chinook_ref</span>, </span>
<span>  mixture <span class="op">=</span> <span class="va">small_chinook_mix</span>, </span>
<span>  gen_start_col <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"BR"</span>,</span>
<span>  reps <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  burn_in <span class="op">=</span> <span class="fl">35</span>,</span>
<span>  prelim_reps <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  prelim_burn_in <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Collating data; compiling reference allele frequencies, etc.   time: 0.10 seconds</span></span>
<span><span class="co">## Computing reference locus specific means and variances for computing mixture z-scores   time: 0.01 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec3 with 29 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##     performing 100 initial sweeps, 50 of which are burn-in and will not be used in computing averages to initialize starting point for method "BR".   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 100 sweeps of method "BR", 35 sweeps of which are burn-in.   time: 0.03 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.10 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec1 with 36 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##     performing 100 initial sweeps, 50 of which are burn-in and will not be used in computing averages to initialize starting point for method "BR".   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 100 sweeps of method "BR", 35 sweeps of which are burn-in.   time: 0.03 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.10 seconds</span></span>
<span><span class="co">## Working on mixture collection: rec2 with 35 individuals</span></span>
<span><span class="co">##   calculating log-likelihoods of the mixture individuals.   time: 0.00 seconds</span></span>
<span><span class="co">##     performing 100 initial sweeps, 50 of which are burn-in and will not be used in computing averages to initialize starting point for method "BR".   time: 0.00 seconds</span></span>
<span><span class="co">##   performing 100 sweeps of method "BR", 35 sweeps of which are burn-in.   time: 0.03 seconds</span></span>
<span><span class="co">##   tidying output into a tibble.   time: 0.10 seconds</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prelimpi</span> <span class="op">&lt;-</span>  <span class="va">prelim_full_model</span><span class="op">$</span><span class="va">mix_prop_traces</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sweep</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sweep</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prelim_pi <span class="op">=</span> <span class="va">pi</span>, full_pi <span class="op">=</span> <span class="va">prelim_full_model</span><span class="op">$</span><span class="va">mixing_proportions</span><span class="op">$</span><span class="va">pi</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">prelimpi</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">prelim_pi</span>, y <span class="op">=</span> <span class="va">full_pi</span>, colour <span class="op">=</span> <span class="va">collection</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">mixture_collection</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rubias-fully-bayesian_files/figure-html/full_prelim-1.png" width="672"></p>
<p>In this case, the results are largely identical to those from uniform
initial proportions, potentially because the collections are
well-resolved to begin with.</p>
</div>
</div>
<div class="section level2">
<h2 id="managing-parallelization">Managing Parallelization<a class="anchor" aria-label="anchor" href="#managing-parallelization"></a>
</h2>
<p>To incorporate baseline updates while keeping runtimes reasonable,
genotype likelihood calculations in the fully Bayesian model are
parallelized using <code>RcppParallel</code>. By default,
<code>RcppParallel</code> runs one thread per core on your machine; to
check the number of cores available, use the <code>detectCores()</code>
function from package <code>parallel</code>. However, this default
behavior is dangerous on HPC systems, where a mismatch between the
number of cores requested by the user and the number of threads demanded
by <code>RcppParallel</code> might cause the job to abort. In these
cases, the number of threads should be manually set with
<code><a href="https://rdrr.io/pkg/RcppParallel/man/setThreadOptions.html" class="external-link">RcppParallel::setThreadOptions</a></code>. For example, to set the
number of threads used to 1:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RcppParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppParallel/man/setThreadOptions.html" class="external-link">setThreadOptions</a></span><span class="op">(</span>numThreads <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Then you would run it just like before:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/infer_mixture.html">infer_mixture</a></span><span class="op">(</span></span>
<span>  reference <span class="op">=</span> <span class="va">small_chinook_ref</span>, </span>
<span>  mixture <span class="op">=</span> <span class="va">small_chinook_mix</span>, </span>
<span>  gen_start_col <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"BR"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This will slow things down relatively to using multiple cores.</p>
<p>To reset the threading options to utilize all available cores, just
use:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">RcppParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppParallel/man/setThreadOptions.html" class="external-link">setThreadOptions</a></span><span class="op">(</span>numThreads <span class="op">=</span> <span class="fu">RcppParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RcppParallel/man/setThreadOptions.html" class="external-link">defaultNumThreads</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Eric C. Anderson, Ben Moran.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
